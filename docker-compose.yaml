version: '3'

services:
    php:
        build:
            context: ./api
        depends_on:
            - db
        env_file:
            - ./api/.env
        # Comment out these volumes in production
        volumes:
            - ./api:/srv/api:rw,cached

    api:
        build:
            context: ./api
            dockerfile: ./Dockerfile.nginx
        depends_on:
            - php
        ports:
            - "8080:80"
        volumes:
            - ./api/public:/srv/api/public:ro
    db:
        # In production, you may want to use a managed database service
        image: postgres:9.6-alpine
        environment:
            - POSTGRES_DB=artefactguide
            - POSTGRES_USER=root
            - POSTGRES_PASSWORD=password!
        volumes:
             - ./docker/db/data:/var/lib/postgresql/data:rw
        ports:
            - "5432:5432"
            
    ldap:
        image: dinkel/openldap:latest
        environment:
#            - SLAPD_FORCE_RECONFIGURE=true
            - SLAPD_DOMAIN=c-base.org
            - SLAPD_PASSWORD=password
#            - SLAPD_LDIF_BASE="/var/tmp/ldifs"
#            - SLAPD_LOAD_LDIFS=""
        volumes:
#            - ./docker/ldap/tmp/ldifs:/var/tmp/ldifs
            - ./docker/ldap/etc/ldap:/etc/ldap 
            - ./docker/ldap/var/lib/ldap:/var/lib/ldap
        ports:
            - "389:389"
